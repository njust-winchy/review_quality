import os
from pprint import pprint
import argparse

import torch
from torch.utils.data import DataLoader
from transformers import RobertaTokenizer, BertForSequenceClassification

import params
from dataset import MyDataset
from model import MyRobertaModel
from utils import read_json, validate

import warnings

warnings.filterwarnings("ignore")


def main(args):
    pprint(args.__dict__)

    # tokenizer
    tokenizer = RobertaTokenizer.from_pretrained(args.pretrained_model_name_or_path)

    # data
    #test_data1 = read_json(os.path.join(args.data_dir, "valid.json"))
    test_data = read_json(os.path.join(args.data_dir, "test.json"))
    #test_data = test_data1 + test_data2
    # dataset, dataloader
    test_set = MyDataset(test_data, tokenizer)
    test_loader = DataLoader(test_set,
                             batch_size=1,
                             shuffle=False,
                             pin_memory=True,
                             num_workers=0,
                             collate_fn=test_set.collate_fn,
                             drop_last=False)

    # model
    model = MyRobertaModel(args.pretrained_model_name_or_path, args.num_classes)
    """
    根据实际使用的模型更改
    model = MyBertModel_Pool(args.pretrained_model_name_or_path, args.num_classes)
    model = BertForSequenceClassification.from_pretrained(args.pretrained_model_name_or_path, args.num_classes)
    """
    # load weights
    weights_path = os.path.join(args.weights_dir, args.weights_name)
    model.load_state_dict(torch.load(weights_path, map_location=args.device))
    model.to(args.device)

    # test
    test_result = validate(model=model, device=args.device, data_loader=test_loader)
    print(test_result)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()

    parser.add_argument('--num_classes', type=int, default=params.num_classes)
    parser.add_argument('--pretrained_model_name_or_path', type=str, default=params.pretrained_model_name_or_path)
    parser.add_argument('--data_dir', type=str, default=params.data_dir)

    parser.add_argument('--device', default=params.device)
    parser.add_argument('--weights_dir', type=str, default=params.save_weights_path)
    parser.add_argument('--weights_name', type=str, default=params.weights_name)

    args = parser.parse_args()

    main(args)
